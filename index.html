<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AE Expression Store</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        /* Custom scrollbar for code blocks */
        pre::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        pre::-webkit-scrollbar-thumb {
            background: #4B5563; /* bg-gray-600 */
            border-radius: 3px;
        }
        pre::-webkit-scrollbar-track {
            background: #1F2937; /* bg-gray-800 */
        }
        /* Simple transition for cards */
        .expression-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .expression-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-white">After Effects Expression Store</h1>
            <p class="text-gray-400 mt-2">Your personal, cloud-synced collection of AE expressions.</p>
        </header>

        <!-- Add Expression Form -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8 max-w-4xl mx-auto">
            <form id="add-expression-form">
                <h2 class="text-2xl font-semibold text-white mb-4">Add New Expression</h2>
                <div class="mb-4">
                    <label for="expression-title" class="block text-sm font-medium text-gray-300 mb-1">Title</label>
                    <input type="text" id="expression-title" name="title" required
                           class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                           placeholder="e.g., Wiggle Loop">
                </div>
                <div class="mb-4">
                    <label for="expression-code" class="block text-sm font-medium text-gray-300 mb-1">Expression</label>
                    <textarea id="expression-code" name="expression" rows="4" required
                              class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                              placeholder="freq = 1; amp = 110; loopTime = 3; ..."></textarea>
                </div>
                <button type="submit"
                        class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500">
                    Add Expression
                </button>
            </form>
        </div>

        <!-- Expressions Grid -->
        <div id="expressions-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Expression cards will be injected here by JavaScript -->
        </div>

        <!-- Pagination -->
        <div id="pagination-controls" class="flex justify-center items-center mt-8 space-x-4">
            <!-- Pagination buttons will be injected here -->
        </div>
        
        <!-- User ID Display -->
        <div class="text-center mt-8">
            <p class="text-gray-500 text-sm">Your User ID (for sharing/syncing): <code id="user-id-display" class="bg-gray-700 p-1 rounded">Loading...</code></p>
        </div>

    </div>
    
    <!-- Notification Toast -->
    <div id="notification-toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
        Copied to clipboard!
    </div>
    
    <!-- Deletion Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 transition-opacity duration-300">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm m-4">
            <h3 class="text-lg font-bold text-white mb-4">Confirm Deletion</h3>
            <p class="text-gray-300 mb-6">Are you sure you want to delete this expression? This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md transition-colors">Cancel</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Delete</button>
            </div>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration and Initialization ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "...", projectId: "..." };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-ae-store';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State Management ---
        let expressions = [];
        let currentPage = 1;
        const expressionsPerPage = 20;
        let userId = null;
        let unsubscribe = null; // To hold the onSnapshot listener
        let expressionIdToDelete = null; // To hold ID for modal confirmation

        // --- DOM Elements ---
        const form = document.getElementById('add-expression-form');
        const container = document.getElementById('expressions-container');
        const paginationControls = document.getElementById('pagination-controls');
        const notificationToast = document.getElementById('notification-toast');
        const userIdDisplay = document.getElementById('user-id-display');
        const deleteModal = document.getElementById('delete-modal');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');


        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User is signed in with UID:", user.uid);
                userId = user.uid;
                userIdDisplay.textContent = userId;
                // Once authenticated, start listening for data changes
                listenForExpressions();
            } else {
                console.log("No user signed in, attempting to sign in...");
                userIdDisplay.textContent = 'Authenticating...';
                try {
                     if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                     } else {
                        await signInAnonymously(auth);
                     }
                } catch (error) {
                    console.error("Error signing in:", error);
                    userIdDisplay.textContent = 'Authentication Failed';
                }
            }
        });

        // --- Firestore Data Listener ---
        function listenForExpressions() {
            if (!userId) {
                console.error("Cannot listen for expressions: User not authenticated.");
                return;
            }
            if (unsubscribe) unsubscribe();
            
            const expressionsCollectionPath = `artifacts/${appId}/users/${userId}/expressions`;
            const q = query(collection(db, expressionsCollectionPath));

            unsubscribe = onSnapshot(q, (snapshot) => {
                expressions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                expressions.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                render();
            }, (error) => {
                console.error("Error fetching expressions:", error);
            });
        }
        
        // --- Rendering Logic ---
        function render() {
            renderExpressions();
            renderPagination();
        }

        function renderExpressions() {
            container.innerHTML = ''; 
            
            if (expressions.length === 0) {
                 container.innerHTML = `<p class="text-gray-400 md:col-span-2 text-center">No expressions yet. Add one using the form above!</p>`;
                 return;
            }

            const startIndex = (currentPage - 1) * expressionsPerPage;
            const paginatedExpressions = expressions.slice(startIndex, startIndex + expressionsPerPage);

            paginatedExpressions.forEach(expr => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-5 rounded-lg shadow-md flex flex-col expression-card';
                card.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-white mb-2 truncate">${escapeHTML(expr.title)}</h3>
                        <div class="bg-gray-900 rounded-md p-3 max-h-48 overflow-y-auto">
                            <pre class="text-sm text-gray-300 whitespace-pre-wrap break-words"><code>${escapeHTML(expr.code)}</code></pre>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center space-x-2">
                        <button data-code="${escapeHTML(expr.code)}" class="copy-btn flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-md text-sm transition-colors">Copy</button>
                        <button data-id="${expr.id}" class="delete-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-md text-sm transition-colors">Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function renderPagination() {
            paginationControls.innerHTML = '';
            const pageCount = Math.ceil(expressions.length / expressionsPerPage);
            if (pageCount <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.className = 'bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    render();
                }
            });
            paginationControls.appendChild(prevButton);

            const pageIndicator = document.createElement('span');
            pageIndicator.className = 'text-gray-400';
            pageIndicator.textContent = `Page ${currentPage} of ${pageCount}`;
            paginationControls.appendChild(pageIndicator);
            
            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.className = 'bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed';
            nextButton.disabled = currentPage === pageCount;
            nextButton.addEventListener('click', () => {
                if (currentPage < pageCount) {
                    currentPage++;
                    render();
                }
            });
            paginationControls.appendChild(nextButton);
        }

        // --- Event Handlers ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) {
                showNotification("Error: Not authenticated. Please refresh.", true);
                return;
            }
            const title = form.title.value.trim();
            const code = form.expression.value.trim();
            if (title && code) {
                try {
                    const expressionsCollectionPath = `artifacts/${appId}/users/${userId}/expressions`;
                    await addDoc(collection(db, expressionsCollectionPath), {
                        title: title,
                        code: code,
                        createdAt: Date.now()
                    });
                    form.reset();
                    showNotification('Expression added successfully!');
                } catch (error) {
                    console.error("Error adding document: ", error);
                    showNotification('Failed to add expression.', true);
                }
            }
        });

        container.addEventListener('click', (e) => {
            if (e.target.classList.contains('copy-btn')) {
                const codeToCopy = e.target.dataset.code;
                const textArea = document.createElement("textarea");
                textArea.value = codeToCopy;
                textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification('Copied to clipboard!');
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    showNotification('Failed to copy.', true);
                }
                document.body.removeChild(textArea);
            }
            
            if (e.target.classList.contains('delete-btn')) {
                expressionIdToDelete = e.target.dataset.id;
                deleteModal.classList.remove('hidden');
            }
        });

        // --- Modal Event Handlers ---
        modalCancelBtn.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            expressionIdToDelete = null;
        });

        modalConfirmBtn.addEventListener('click', async () => {
            if (expressionIdToDelete && userId) {
                try {
                    const docPath = `artifacts/${appId}/users/${userId}/expressions/${expressionIdToDelete}`;
                    await deleteDoc(doc(db, docPath));
                    showNotification('Expression deleted successfully.');
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    showNotification('Failed to delete expression.', true);
                }
            }
            deleteModal.classList.add('hidden');
            expressionIdToDelete = null;
        });


        // --- Utility Functions ---
        function showNotification(message, isError = false) {
            notificationToast.textContent = message;
            notificationToast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            notificationToast.classList.remove('opacity-0');
            setTimeout(() => {
                notificationToast.classList.add('opacity-0');
            }, 3000);
        }
        
        function escapeHTML(str) {
            const p = document.createElement("p");
            p.appendChild(document.createTextNode(str));
            return p.innerHTML;
        }

    </script>

</body>
</html>

